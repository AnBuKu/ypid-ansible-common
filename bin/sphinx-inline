#!/bin/bash
## @license AGPLv3 <https://www.gnu.org/licenses/agpl-3.0.html>
## @author Copyright (C) 2015 Robin Schneider <ypid@riseup.net>

# Convert repetitively used programs and commands to Sphinx inline syntax.
# http://www.sphinx-doc.org/en/stable/markup/inline.html
#
# Note you should review the changes made by this script and try to build the
# documentation as this script can not handle all cases. You might need to
# revert some of the changes manually.

# Don’t use:
# * :option:`--tags`: https://github.com/debops/ansible-atd/pull/3#issuecomment-152024188
#
# Use:
# * :file:`/etc/issue`
# * :command:`rm`: The name of an OS-level command, such as `rm`. Used when
#   referring to a program primely used in the shell (CLI interface) by sysadmins
#   and/or users.
# * :program:`rsnapshot`: The name of an executable program. This may differ
#   from the file name for the executable for some platforms. In particular, the
#   .exe (or other) extension should be omitted for Windows programs.
#   Used when referring to programs (GUI, or programs not intended as shell
#   command) or services (not intended for user/admin execution directly but
#   via a init system/cron/something).
# * :rfc:`number#anchor`
# * :manpage:`ls(1)`
# * :regexp:`^WARN.*$`
# * :envvar:`example__variable`: See https://github.com/debops/docs/issues/153

## Script is expected to be run from the root of a role!
role_full_name="$(basename "$PWD")"
role_name="${role_full_name#*.}"
role_owner="${role_full_name%.*}"
echo "Running sphinx-inline for: '$role_name', full role name: '$role_full_name', role owner is: '$role_owner'"

## For testing:
# git ls-files -z | xargs --null -I '{}' find '{}' -type f -regextype posix-extended -regex '(:?defaults/.*\.yml|.*\.rst)$' -print0 | \
#     xargs --null sed --in-place --regexp-extended '
#     '

# echo '``apt-cache.{{ ansible_domain }}``. This subdomain should be configured in the' | \
	# sed --regexp-extended '

# exit 0

git ls-files -z | xargs --null -I '{}' find '{}' -type f -regextype posix-extended -regex '(:?defaults/.*\.yml|.*\.rst)$' -print0 | \
	xargs --null sed --in-place --regexp-extended '
		s/``(\/[^`]+[^`0-9])``/:file:`\1`/g;
		s/``([^`]+\w+\.(:?yml|yaml|rst|j2|ini))``/:file:`\1`/g;
		s/``((:?whereami|fail2ban|libvirtd|pki-realm|pki-authority|acme-tiny|apt-(:?cacher-ng|proxy)|nginx|etckeeper|irqbalance|rsnapshot|mysqld|collectd|ntpd|xinetd|opsi-product-updater|automysqlbackup|cron|dhclient|ferm|ferment)\b[^`{.]*?[^_]?)``/:program:`\1`/g;
		s/``((:?hostname|sudo|which|fsck|mysql|mkfs|openssl|chattr|lsattr|gnutls|smbclient|update-ca-certificates|ansible(:?-vault|-playbook)?|debops-padlock|vgcreate|firejail|xpra|yaml2rst|occ|check_mk|docker|setxkbmap|setxkbmap -query|xmllint|gpg2?|git|hg|bzr|darcs|apt|dpkg|rpm|pacman|pacman-g2|yum|dnf|zypper|rsync|ssh|ip|ip(6|\(6\))?tables|netstat)\b[^ `.{]*?[^_]?)``/:command:`\1`/g;
		s/``([[:lower:]_-]+\([[:digit:]]\))``/:manpage:`\1`/g;
		s/``([[:alnum:]_]+__[^*?` ]+?[^*?` _])``/:envvar:`\1`/g;
		s/``(debops\.[[:alnum:]_-]+)``/\1_/g;
		s/([\[ ]drybjed|ypid|ganto|htgoebel|nickjj|scibi|do3cc|AnBuKu|thiagotalma)([^_])/\1_\2/g;
		s/\*\*(drybjed|ypid|ganto|htgoebel|nickjj|scibi|do3cc|AnBuKu|thiagotalma)\*\*/\1_/g;
		s/([^`])(debops tools)([^`])/\1`DebOps Tools`_\3/gi;
		s/The current role maintainer is/The current role maintainer_ is/gi;
		s/\<e\.g\./e. g./g;
		s#(`Semantic Versioning <http://semver\.org/spec/v2\.0\.0\.html>`_)\b#\1_#;
	'

# Disabled due to false positives:
# s/([[:lower:]_-]+\([[:digit:]]\))(\s)/:manpage:`\1`\2/g;  ## Would also match: d(1)

## Use NARROW NO-BREAK SPACE: https://en.wikipedia.org/wiki/Thin_space
## If you can’t handle Unicode, that’s your problem. Deal with it!


## Revert a change for the role itself because a self reference (currently points to GitHub) might be confusing.
git ls-files -z | xargs --null -I '{}' find '{}' -type f -regextype posix-extended -regex '(:?defaults/.*\.yml|.*\.rst)$' -print0 | \
	xargs --null sed --in-place --regexp-extended "
			s/\b${role_full_name}_\b/\`\`${role_full_name}\`\`/g;
		"

## Revert a change for deprecated roles (might be removed from the documentation at some point).
git ls-files -z | xargs --null -I '{}' find '{}' -type f -regextype posix-extended -regex '(:?defaults/.*\.yml|.*\.rst)$' -print0 | \
	xargs --null sed --in-place --regexp-extended "
			s/\b(debops\.(:?php5|sshkeys))_\b/\`\`\1\`\`/g;
		"

## Revert other changes.
git ls-files -z | xargs --null -I '{}' find '{}' -type f -regextype posix-extended -regex '(:?defaults/.*\.yml|.*\.rst)$' -print0 | \
	xargs --null sed --in-place --regexp-extended '
			s/:envvar:`((:?owncloud__enable_occ_shortcut|php__pool_default|php__version))`/``\1``/g;
		'

echo "Done. Be sure to review the changes."
