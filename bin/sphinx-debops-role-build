#!/bin/bash

ROLE_TEMPLATE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../template_role/" && pwd )"
SPHINX_DOCS_TEMPLATE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../integration_testing/ypid/sphinx-docs-template/" && pwd )"

if [ ! -d "docs" ]
then
    echo "You need to create the docs directory in the role." 1>&2
    exit 1
fi

if [ ! -d "$ROLE_TEMPLATE_DIR" ]
then
    echo "Role template directory does not exist."
    exit 1
fi

if [ ! -d "$SPHINX_DOCS_TEMPLATE_DIR" ]
then
    echo "Sphinx docs template directory does not exist."
    exit 1
fi

cp -f "${SPHINX_DOCS_TEMPLATE_DIR}"/* ./docs/
test -e .gitignore || cp "${ROLE_TEMPLATE_DIR}/.gitignore" .gitignore
cd docs || exit
test -d _static || mkdir -p _static
test -f ../defaults/main.yml && yaml2rst ../defaults/main.yml defaults.rst --strip-regex '\s*(:?\[{3}|\]{3})\d?$'
touch index.rst
sphinx-build -n -W -b html -d _build/doctrees . _build/html

if [[ $? != 0 ]] && [[ -d "includes" ]]
then
    cp ~/.ansible/ypid-ansible-common/template_role/docs/includes/global.rst includes/global.rst
    sphinx-build -n -W -b html -d _build/doctrees . _build/html
fi
